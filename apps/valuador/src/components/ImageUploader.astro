---
interface Props {
  maxFiles?: number;
  maxFileSize?: number; // en MB
  acceptedTypes?: string;
  id?: string;
}

const {
  maxFiles = 5,
  maxFileSize = 5, // 5MB por defecto
  acceptedTypes = "image/*",
  id = "image-uploader"
} = Astro.props;
---

<div class="image-uploader">
  <div class="border-2 border-dashed border-border rounded-lg p-8 text-center bg-background">
    <div class="mx-auto w-16 h-16 flex items-center justify-center bg-azul-claro/10 text-azul-claro rounded-full mb-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    </div>
    <p class="mb-2 font-medium">Arrastra imágenes aquí o <span class="text-azul-claro">haz clic para buscar</span></p>
    <p class="text-text-muted text-sm">
      {acceptedTypes.replace('image/*', 'PNG, JPG')} hasta {maxFileSize}MB (máx. {maxFiles} {maxFiles === 1 ? 'foto' : 'fotos'})
    </p>
    <input type="file" multiple accept={acceptedTypes} class="hidden" id={id}>
    <button 
      type="button" 
      onclick={`document.getElementById('${id}').click()`} 
      class="mt-4 inline-flex items-center px-4 py-2 bg-background border border-border rounded-md hover:bg-background-alt transition-colors text-sm"
    >
      Seleccionar archivos
    </button>
  </div>
  
  <div class="mt-4 grid grid-cols-5 gap-3 photo-preview hidden">
    <!-- Aquí se mostrarán las fotos después de cargarlas con JavaScript -->
  </div>
</div>

<script define:vars={{ id, maxFiles, maxFileSize }}>
  document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById(id);
    const container = fileInput?.closest('.image-uploader');
    const previewContainer = container?.querySelector('.photo-preview');
    
    fileInput?.addEventListener('change', function() {
      if (this.files && this.files.length > 0) {
        previewContainer?.classList.remove('hidden');
        
        // Limpiar el contenedor de vista previa
        if (previewContainer) {
          previewContainer.innerHTML = '';
        }
        
        // Mostrar una vista previa de cada imagen
        for (let i = 0; i < Math.min(this.files.length, maxFiles); i++) {
          const file = this.files[i];
          
          // Verificar tamaño del archivo
          if (file.size > maxFileSize * 1024 * 1024) {
            alert(`El archivo ${file.name} excede el tamaño máximo de ${maxFileSize}MB.`);
            continue;
          }
          
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'relative aspect-square rounded-lg overflow-hidden bg-background-alt';
            div.dataset.filename = file.name;
            
            const img = document.createElement('img');
            img.src = e.target?.result;
            img.className = 'w-full h-full object-cover';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'absolute top-1 right-1 bg-rosa text-white rounded-full w-6 h-6 flex items-center justify-center';
            removeBtn.innerHTML = '×';
            removeBtn.type = 'button';
            removeBtn.addEventListener('click', function() {
              div.remove();
              // Si no hay más previsualizaciones, ocultar el contenedor
              if (previewContainer?.children.length === 0) {
                previewContainer.classList.add('hidden');
              }
            });
            
            div.appendChild(img);
            div.appendChild(removeBtn);
            previewContainer?.appendChild(div);
          }
          
          reader.readAsDataURL(file);
        }
      }
    });
  });
</script> 