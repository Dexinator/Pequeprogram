---
import ImageUploader from './ImageUploader.astro';

interface Props {
  id?: string;
  index?: number;
  className?: string;
}

const { id = "producto-form", index = 0, className = "" } = Astro.props;
const productoId = `${id}-${index}`;

// Datos de prueba para las categorías
const categorias = [
  { id: 1, nombre: "Ropa Infantil" },
  { id: 2, nombre: "Juguetes" },
  { id: 3, nombre: "Mobiliario" },
  { id: 4, nombre: "Coches y Sillas" },
  { id: 5, nombre: "Lactancia" },
  { id: 6, nombre: "Accesorios" }
];

// Datos de prueba para subcategorías
const subcategorias = {
  1: [
    { id: 101, nombre: "Ropa (0-6 meses)" },
    { id: 102, nombre: "Ropa (6-12 meses)" },
    { id: 103, nombre: "Ropa (1-3 años)" },
    { id: 104, nombre: "Ropa (3+ años)" }
  ],
  2: [
    { id: 201, nombre: "Juguetes didácticos" },
    { id: 202, nombre: "Muñecas y figuras" },
    { id: 203, nombre: "Juegos de mesa" },
    { id: 204, nombre: "Vehículos y pistas" }
  ],
  3: [
    { id: 301, nombre: "Cunas" },
    { id: 302, nombre: "Moisés" },
    { id: 303, nombre: "Cómodas" },
    { id: 304, nombre: "Parques" }
  ],
  4: [
    { id: 401, nombre: "Cochecitos" },
    { id: 402, nombre: "Sillas de auto" },
    { id: 403, nombre: "Portabebés" }
  ],
  5: [
    { id: 501, nombre: "Extractores" },
    { id: 502, nombre: "Biberones" },
    { id: 503, nombre: "Esterilizadores" }
  ],
  6: [
    { id: 601, nombre: "Chupetes" },
    { id: 602, nombre: "Mordedores" },
    { id: 603, nombre: "Monitores" }
  ]
};
---
<div class={`producto-form ${className}`} data-index={index}>
  <div class="bg-background-alt p-6 rounded-lg shadow-sm border border-border mb-6">
    <div class="flex justify-between items-start mb-4">
      <h2 class="text-xl font-heading font-bold text-azul-claro">Producto #{index + 1}</h2>
      
      {index > 0 && (
        <button type="button" class="text-rosa hover:text-rosa/80 p-1 remove-producto">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      )}
    </div>
    
    <!-- Sección 1: Información Básica -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="space-y-2">
        <label class="block font-medium" for={`categoria-${productoId}`}>
          Categoría <span class="text-rosa">*</span>
        </label>
        <select 
          id={`categoria-${productoId}`} 
          name={`categoria-${productoId}`} 
          data-producto-id={productoId}
          class="categoria-select w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          required
        >
          <option value="">Seleccionar categoría</option>
          {categorias.map(cat => (
            <option value={cat.id}>{cat.nombre}</option>
          ))}
        </select>
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium" for={`subcategoria-${productoId}`}>
          Subcategoría <span class="text-rosa">*</span>
        </label>
        <select 
          id={`subcategoria-${productoId}`} 
          name={`subcategoria-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          required
          disabled
        >
          <option value="">Seleccione primero una categoría</option>
        </select>
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium" for={`status-${productoId}`}>
          Status <span class="text-rosa">*</span>
        </label>
        <select 
          id={`status-${productoId}`} 
          name={`status-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          required
        >
          <option value="">Seleccionar status</option>
          <option value="nuevo">Nuevo</option>
          <option value="usado_como_nuevo">Usado como nuevo</option>
          <option value="usado_con_detalle">Usado con algún detalle</option>
        </select>
      </div>
    </div>
    
    <!-- Sección 2: Marca y Características -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="space-y-2">
        <label class="block font-medium" for={`marca-${productoId}`}>
          Marca <span class="text-rosa">*</span>
        </label>
        <div class="flex gap-2">
          <select 
            id={`marca-${productoId}`} 
            name={`marca-${productoId}`} 
            class="flex-1 p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          >
            <option value="">Seleccionar marca</option>
            <option value="fisher_price">Fisher Price</option>
            <option value="chicco">Chicco</option>
            <option value="graco">Graco</option>
            <option value="carter">Carter's</option>
            <option value="otro">Otra marca...</option>
          </select>
          <button 
            type="button"
            id={`nueva-marca-btn-${productoId}`}
            class="px-3 py-2 bg-background border border-border rounded-md hover:bg-background-alt transition-colors"
          >
            +
          </button>
        </div>
        
        <div id={`nueva-marca-container-${productoId}`} class="mt-2 hidden">
          <input 
            type="text" 
            id={`nueva-marca-${productoId}`} 
            name={`nueva-marca-${productoId}`} 
            class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
            placeholder="Nombre de la marca" 
          />
        </div>
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium" for={`renombre-${productoId}`}>
          Renombre de Marca <span class="text-rosa">*</span>
        </label>
        <select 
          id={`renombre-${productoId}`} 
          name={`renombre-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          required
        >
          <option value="">Seleccionar renombre</option>
          <option value="sencilla">Sencilla</option>
          <option value="normal">Normal</option>
          <option value="alta">Alta</option>
          <option value="premium">Premium</option>
        </select>
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium" for={`modalidad-${productoId}`}>
          Modalidad <span class="text-rosa">*</span>
        </label>
        <select 
          id={`modalidad-${productoId}`} 
          name={`modalidad-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          required
        >
          <option value="">Seleccionar modalidad</option>
          <option value="compra">Compra directa</option>
          <option value="consignacion">Consignación</option>
        </select>
      </div>
    </div>
    
    <!-- Sección 3: Características principales (Features) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="space-y-2">
        <label class="block font-medium" for={`feature1-${productoId}`}>
          Característica 1
        </label>
        <input 
          type="text" 
          id={`feature1-${productoId}`} 
          name={`feature1-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          placeholder="Ej: Tamaño, color, material..." 
        />
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium" for={`feature2-${productoId}`}>
          Característica 2
        </label>
        <input 
          type="text" 
          id={`feature2-${productoId}`} 
          name={`feature2-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          placeholder="Ej: Capacidad, peso, modelo..." 
        />
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium" for={`feature3-${productoId}`}>
          Característica 3
        </label>
        <input 
          type="text" 
          id={`feature3-${productoId}`} 
          name={`feature3-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          placeholder="Ej: Material, diseño..." 
        />
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium" for={`feature4-${productoId}`}>
          Característica 4
        </label>
        <input 
          type="text" 
          id={`feature4-${productoId}`} 
          name={`feature4-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          placeholder="Ej: Accesorios, extras..." 
        />
      </div>
      
      <div class="space-y-2 md:col-span-2">
        <button 
          type="button" 
          id={`mostrar-mas-features-${productoId}`}
          class="text-sm text-azul-claro hover:text-azul-profundo transition-colors"
        >
          + Mostrar más características
        </button>
        
        <div id={`mas-features-${productoId}`} class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
          <div class="space-y-2">
            <label class="block font-medium" for={`feature5-${productoId}`}>
              Característica 5
            </label>
            <input 
              type="text" 
              id={`feature5-${productoId}`} 
              name={`feature5-${productoId}`} 
              class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
              placeholder="Característica adicional" 
            />
          </div>
          
          <div class="space-y-2">
            <label class="block font-medium" for={`feature6-${productoId}`}>
              Característica 6
            </label>
            <input 
              type="text" 
              id={`feature6-${productoId}`} 
              name={`feature6-${productoId}`} 
              class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
              placeholder="Característica adicional" 
            />
          </div>
        </div>
      </div>
    </div>
    
    <!-- Sección 4: Condición y Demanda -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="space-y-2">
        <label class="block font-medium" for={`estado-${productoId}`}>
          Estado <span class="text-rosa">*</span>
        </label>
        <select 
          id={`estado-${productoId}`} 
          name={`estado-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          required
        >
          <option value="">Seleccionar estado</option>
          <option value="excelente">Excelente</option>
          <option value="bueno">Bueno</option>
          <option value="regular">Regular</option>
        </select>
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium" for={`demanda-${productoId}`}>
          Demanda <span class="text-rosa">*</span>
        </label>
        <select 
          id={`demanda-${productoId}`} 
          name={`demanda-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          required
        >
          <option value="">Seleccionar demanda</option>
          <option value="alta">Alta</option>
          <option value="media">Media</option>
          <option value="baja">Baja</option>
        </select>
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium" for={`limpieza-${productoId}`}>
          Limpieza <span class="text-rosa">*</span>
        </label>
        <select 
          id={`limpieza-${productoId}`} 
          name={`limpieza-${productoId}`} 
          class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
          required
        >
          <option value="">Seleccionar limpieza</option>
          <option value="buena">Buena</option>
          <option value="regular">Regular</option>
          <option value="mala">Mala</option>
        </select>
      </div>
    </div>
    
    <!-- Sección 5: Precio Nuevo y Fotografías -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="space-y-2">
        <label class="block font-medium" for={`precio-nuevo-${productoId}`}>
          Precio Nuevo <span class="text-rosa">*</span>
        </label>
        <div class="flex gap-2">
          <div class="relative flex-1">
            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-text-muted">$</span>
            <input 
              type="number" 
              id={`precio-nuevo-${productoId}`} 
              name={`precio-nuevo-${productoId}`} 
              class="w-full p-2 pl-8 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
              placeholder="0.00" 
              min="0" 
              step="0.01" 
              required
            />
          </div>
          <button 
            type="button" 
            class="px-3 py-2 bg-background border border-border rounded-md hover:bg-background-alt transition-colors"
            id={`buscar-precio-${productoId}`}
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-azul-claro" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </button>
        </div>
        <p class="text-sm text-text-muted mt-1">Precio aproximado en el mercado para el producto nuevo</p>
      </div>
      
      <div class="space-y-2">
        <label class="block font-medium">
          Fotografías
        </label>
        <ImageUploader id={`fotos-${productoId}`} maxFiles={3} maxFileSize={2} />
      </div>
    </div>
    
    <!-- Sección 6: Observaciones -->
    <div class="space-y-2 mb-6">
      <label class="block font-medium" for={`observaciones-${productoId}`}>
        Observaciones
      </label>
      <textarea 
        id={`observaciones-${productoId}`} 
        name={`observaciones-${productoId}`} 
        rows="2" 
        class="w-full p-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-azul-claro/50 focus:border-azul-claro outline-none transition-all"
        placeholder="Detalles adicionales o estado del producto..."
      ></textarea>
    </div>
    
    <!-- Botón de valuación -->
    <div class="flex justify-end">
      <button 
        type="button" 
        id={`valuar-btn-${productoId}`}
        class="px-5 py-2 bg-verde-lima text-white rounded-md hover:bg-verde-oscuro transition-colors"
      >
        Valuar Producto
      </button>
    </div>
    
    <!-- Resultado de valuación (oculto inicialmente) -->
    <div id={`resultado-${productoId}`} class="mt-6 p-5 bg-verde-lima/10 border border-verde-lima/30 rounded-lg hidden">
      <h3 class="text-lg font-heading font-bold text-verde-oscuro mb-3">Resultado de la Valuación</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
        <div>
          <p class="text-sm text-text-muted">Precio de Venta Sugerido:</p>
          <p class="text-xl font-bold text-verde-oscuro">$<span id={`precio-venta-${productoId}`}>0.00</span></p>
        </div>
        
        <div>
          <p class="text-sm text-text-muted">Precio de Compra Sugerido:</p>
          <p class="text-xl font-bold text-azul-profundo">$<span id={`precio-compra-${productoId}`}>0.00</span></p>
        </div>
        
        <div id={`consignacion-info-${productoId}`} class="hidden">
          <p class="text-sm text-text-muted">Consignación (tras venta):</p>
          <p class="text-xl font-bold text-azul-profundo">$<span id={`precio-consignacion-${productoId}`}>0.00</span></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ index, productoId, subcategorias }}>
  document.addEventListener('DOMContentLoaded', () => {
    // Manejo de selección de categoría/subcategoría
    const categoriaSelect = document.getElementById(`categoria-${productoId}`);
    const subcategoriaSelect = document.getElementById(`subcategoria-${productoId}`);
    
    if (categoriaSelect && subcategoriaSelect) {
      categoriaSelect.addEventListener('change', () => {
        const categoriaId = categoriaSelect.value;
        subcategoriaSelect.innerHTML = '<option value="">Seleccionar subcategoría</option>';
        subcategoriaSelect.disabled = !categoriaId;
        
        if (categoriaId && subcategorias[categoriaId]) {
          subcategorias[categoriaId].forEach(subcat => {
            const option = document.createElement('option');
            option.value = subcat.id;
            option.textContent = subcat.nombre;
            subcategoriaSelect.appendChild(option);
          });
        }
      });
    }
    
    // Manejo del botón de nueva marca
    const marcaSelect = document.getElementById(`marca-${productoId}`);
    const nuevaMarcaBtn = document.getElementById(`nueva-marca-btn-${productoId}`);
    const nuevaMarcaContainer = document.getElementById(`nueva-marca-container-${productoId}`);
    
    if (marcaSelect && nuevaMarcaBtn && nuevaMarcaContainer) {
      nuevaMarcaBtn.addEventListener('click', () => {
        nuevaMarcaContainer.classList.toggle('hidden');
      });
      
      marcaSelect.addEventListener('change', () => {
        if (marcaSelect.value === 'otro') {
          nuevaMarcaContainer.classList.remove('hidden');
        } else {
          nuevaMarcaContainer.classList.add('hidden');
        }
      });
    }
    
    // Manejo de características adicionales
    const mostrarMasFeaturesBtn = document.getElementById(`mostrar-mas-features-${productoId}`);
    const masFeaturesContainer = document.getElementById(`mas-features-${productoId}`);
    
    if (mostrarMasFeaturesBtn && masFeaturesContainer) {
      mostrarMasFeaturesBtn.addEventListener('click', () => {
        masFeaturesContainer.classList.toggle('hidden');
        mostrarMasFeaturesBtn.textContent = masFeaturesContainer.classList.contains('hidden') ? 
          '+ Mostrar más características' : '- Ocultar características adicionales';
      });
    }
    
    // Manejo de modalidad (consignación/compra)
    const modalidadSelect = document.getElementById(`modalidad-${productoId}`);
    const consignacionInfo = document.getElementById(`consignacion-info-${productoId}`);
    
    if (modalidadSelect && consignacionInfo) {
      modalidadSelect.addEventListener('change', () => {
        if (modalidadSelect.value === 'consignacion') {
          consignacionInfo.classList.remove('hidden');
        } else {
          consignacionInfo.classList.add('hidden');
        }
      });
    }
    
    // Manejo del botón de valuación
    const valuarBtn = document.getElementById(`valuar-btn-${productoId}`);
    const resultadoContainer = document.getElementById(`resultado-${productoId}`);
    const precioNuevoInput = document.getElementById(`precio-nuevo-${productoId}`);
    const precioVentaSpan = document.getElementById(`precio-venta-${productoId}`);
    const precioCompraSpan = document.getElementById(`precio-compra-${productoId}`);
    const precioConsignacionSpan = document.getElementById(`precio-consignacion-${productoId}`);
    
    if (valuarBtn && resultadoContainer && precioNuevoInput && precioVentaSpan && precioCompraSpan && precioConsignacionSpan) {
      valuarBtn.addEventListener('click', () => {
        // Datos de ejemplo para GAP y márgenes
        const gapPorCategoria = {
          nuevo: { 1: 0.2, 2: 0.3, 3: 0.25, 4: 0.35, 5: 0.4, 6: 0.3 },
          usado: { 1: 0.5, 2: 0.6, 3: 0.55, 4: 0.65, 5: 0.7, 6: 0.6 }
        };
        
        const margenPorCategoria = {
          nuevo: { 1: 0.3, 2: 0.35, 3: 0.4, 4: 0.45, 5: 0.35, 6: 0.3 },
          usado: { 1: 0.4, 2: 0.45, 3: 0.5, 4: 0.55, 5: 0.5, 6: 0.45 }
        };
        
        // Puntajes de calificación (ejemplo)
        const puntajeEstado = { excelente: 10, bueno: 5, regular: 0 };
        const puntajeDemanda = { alta: 10, media: 5, baja: 0 };
        const puntajeLimpieza = { buena: 5, regular: 0, mala: -5 };
        
        // Obtener valores del formulario
        const categoriaId = categoriaSelect.value;
        const statusProducto = document.getElementById(`status-${productoId}`).value;
        const esNuevo = statusProducto === 'nuevo';
        const estadoValue = document.getElementById(`estado-${productoId}`).value;
        const demandaValue = document.getElementById(`demanda-${productoId}`).value;
        const limpiezaValue = document.getElementById(`limpieza-${productoId}`).value;
        const precioNuevo = parseFloat(precioNuevoInput.value) || 0;
        
        // Calcular calificaciones
        const calificacionCompra = 
          (puntajeEstado[estadoValue] || 0) + 
          (puntajeDemanda[demandaValue] || 0) + 
          (puntajeLimpieza[limpiezaValue] || 0);
          
        const calificacionVenta = 
          (puntajeEstado[estadoValue] || 0) + 
          (puntajeDemanda[demandaValue] || 0);
        
        // Obtener GAP y margen según la categoría y si es nuevo/usado
        const tipoProducto = esNuevo ? 'nuevo' : 'usado';
        const gap = gapPorCategoria[tipoProducto][categoriaId] || 0.5;
        const margen = margenPorCategoria[tipoProducto][categoriaId] || 0.4;
        
        // Calcular precios
        const precioVenta = precioNuevo * (1 - gap + calificacionVenta/100);
        const precioCompra = precioVenta * (1 - margen + calificacionCompra/100);
        const precioConsignacion = precioVenta * 0.7; // 70% para el consignante
        
        // Mostrar resultados
        precioVentaSpan.textContent = precioVenta.toFixed(2);
        precioCompraSpan.textContent = precioCompra.toFixed(2);
        precioConsignacionSpan.textContent = precioConsignacion.toFixed(2);
        resultadoContainer.classList.remove('hidden');
      });
    }
    
    // Funcionalidad para el botón de búsqueda de precio
    const buscarPrecioBtn = document.getElementById(`buscar-precio-${productoId}`);
    if (buscarPrecioBtn) {
      buscarPrecioBtn.addEventListener('click', () => {
        // Simulamos una búsqueda y asignamos un precio aleatorio
        const precio = Math.floor(Math.random() * 5000) + 500;
        precioNuevoInput.value = precio;
        alert('Búsqueda de precio simulada. En una implementación real, se realizaría una consulta a la base de datos o a una API de precios.');
      });
    }
    
    // Manejo del botón de eliminar producto (excepto el primero)
    if (index > 0) {
      const removeBtn = document.querySelector(`.producto-form[data-index="${index}"] .remove-producto`);
      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          const productoForm = this.closest('.producto-form');
          if (productoForm) {
            productoForm.remove();
          }
        });
      }
    }
  });
</script> 