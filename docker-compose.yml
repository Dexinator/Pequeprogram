services:
  db:
    image: postgres:16-alpine # Usar una imagen oficial de PostgreSQL
    container_name: entrepeques-db-dev
    restart: always
    ports:
      - "5432:5432" # Mapear puerto del host al contenedor
    environment:
      POSTGRES_USER: ${DATABASE_USER:-user}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-password}
      POSTGRES_DB: ${DATABASE_NAME:-entrepeques_dev}
    volumes:
      - postgres_data:/var/lib/postgresql/data # Persistir datos de la BD
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-user} -d ${DATABASE_NAME:-entrepeques_dev}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - entrepeques-net

  api:
    container_name: entrepeques-api-dev
    build:
      context: ./packages/api # Volver a contexto específico
      dockerfile: Dockerfile.dev # El Dockerfile.dev ahora está dentro de packages/api
    restart: unless-stopped
    ports:
      - "${API_PORT:-3001}:3001" # Puerto para la API (default 3001)
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://${DATABASE_USER:-user}:${DATABASE_PASSWORD:-password}@db:5432/${DATABASE_NAME:-entrepeques_dev}
      # Añadir otras variables de entorno necesarias para la API aquí
      PORT: 3001
      JWT_SECRET: ${JWT_SECRET:-your-development-secret-key}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:4321}
    volumes:
      - ./packages/api:/app # Mapear código fuente para live reload
      - api_node_modules:/app/node_modules # Evitar sobreescribir node_modules del contenedor
    depends_on:
      db:
        condition: service_healthy
    networks:
      - entrepeques-net

  valuador:
    container_name: entrepeques-valuador-dev
    build:
      context: ./apps/valuador
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    ports:
      - "4321:4321"
    environment:
      NODE_ENV: development
      PUBLIC_API_URL: ${PUBLIC_API_URL:-http://localhost:3001/api}
    volumes:
      - ./apps/valuador:/app
      - valuador_node_modules:/app/node_modules
    depends_on:
      - api
    networks:
      - entrepeques-net

  admin:
    container_name: entrepeques-admin-dev
    build:
      context: ./apps/admin
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    ports:
      - "4322:4322"
    environment:
      NODE_ENV: development
      PUBLIC_API_URL: ${PUBLIC_API_URL:-http://localhost:3001/api}
    volumes:
      - ./apps/admin:/app
      - admin_node_modules:/app/node_modules
    depends_on:
      - api
    networks:
      - entrepeques-net

  tienda:
    container_name: entrepeques-tienda-dev
    build:
      context: ./apps/tienda
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    ports:
      - "4323:4323"
    environment:
      NODE_ENV: development
      PUBLIC_API_URL: ${PUBLIC_API_URL:-http://localhost:3001/api}
    volumes:
      - ./apps/tienda:/app
      - tienda_node_modules:/app/node_modules
    depends_on:
      - api
    networks:
      - entrepeques-net

  pos:
    container_name: entrepeques-pos-dev
    build:
      context: ./apps/pos
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    ports:
      - "4324:4324"
    environment:
      NODE_ENV: development
      PUBLIC_API_URL: ${PUBLIC_API_URL:-http://localhost:3001/api}
    volumes:
      - ./apps/pos:/app
      - pos_node_modules:/app/node_modules
    depends_on:
      - api
    networks:
      - entrepeques-net

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: "admin@admin.com"
      PGADMIN_DEFAULT_PASSWORD: "admin"
    ports:
      - "5050:80"
    depends_on:
      - db
    networks:
      - entrepeques-net

networks:
  entrepeques-net:
    driver: bridge

volumes:
  postgres_data: # Volumen nombrado para la persistencia de datos
  api_node_modules:
  valuador_node_modules:
  admin_node_modules:
  tienda_node_modules:
  pos_node_modules: